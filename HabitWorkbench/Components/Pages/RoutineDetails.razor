@page "/routines/{RoutineId:int}"
@using HabitWorkbench.Data.Models
@inject HabitWorkbench.Data.AppDb Db

<h1>@(routine?.Name ?? "Routine")</h1>

@if (routine is null)
{
    <p>Loading…</p>
}
else
{
    <h3>Habits</h3>

    <!-- ADD HABIT ROW -->
    <div class="habit-add-row">

        <div class="habit-field name">
            <label>Name</label>
            <input @bind="newHabitName" maxlength="80" />
        </div>

        <div class="habit-field order">
            <label>Order</label>
            <input type="number" step="0.01" @bind="newHabitOrder" />
        </div>

        <div class="habit-field good">
            <label>Good</label>
            <div class="checkbox-wrap">
                <input type="checkbox" @bind="newHabitGood" class="habit-checkbox" />
            </div>
        </div>

        <div class="habit-field status">
            <label>Status</label>
            <select @bind="newState">
                <option value="@HabitImplementationState.Active">Active</option>
                <option value="@HabitImplementationState.Desired">Desired</option>
                <option value="@HabitImplementationState.Archived">Archived</option>
            </select>
        </div>

        <div class="habit-field add">
            <button class="btn btn-primary" @onclick="AddHabit">Add</button>
        </div>

    </div>

    <hr class="habit-divider" />

    @if (habits.Count == 0)
    {
        <p>No habits yet.</p>
    }
    else
    {
        @foreach (var s in _sections)
        {
            var items = habits.Where(h => h.ImplementationState == s).ToList();
            if (items.Count == 0) continue;

            <h4 style="margin-top:18px;">@s</h4>

            <table class="table">
                <thead>
                    <tr>
                        <th style="width:120px;">Order</th>
                        <th>Name</th>
                        <th style="width:120px;">Good</th>
                        <th style="width:220px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in items)
                    {
                        <tr>
                            <td>@h.OrderInRoutine</td>
                            <td>
                                <NavLink href="@($"/habits/{h.Id}")">@h.Name</NavLink>
                            </td>
                            <td>@(h.Good ? "Yes" : "No")</td>
                            <td>
                                <button @onclick="() => DeleteHabit(h)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    }
}

@code {
    [Parameter] public int RoutineId { get; set; }

    private static readonly HabitImplementationState[] _sections =
    {
        HabitImplementationState.Active,
        HabitImplementationState.Desired,
        HabitImplementationState.Archived
    };

    private Routine? routine;
    private List<Habit> habits = new();

    private string newHabitName = "";
    private decimal newHabitOrder = 10m;
    private bool newHabitGood = true;

    private HabitImplementationState newState = HabitImplementationState.Active;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        routine = await Db.Conn.FindAsync<Routine>(RoutineId);

        habits = await Db.Conn.Table<Habit>()
            .Where(h => h.RoutineId == RoutineId)
            .OrderBy(h => h.OrderInRoutine)
            .ToListAsync();
    }

    private async Task AddHabit()
    {
        var name = (newHabitName ?? "").Trim();
        if (name.Length == 0) return;

        var habit = new Habit
        {
            RoutineId = RoutineId,
            Name = name.Length > 80 ? name.Substring(0, 80) : name,
            OrderInRoutine = newHabitOrder,
            Good = newHabitGood,
            ImplementationState = newState
        };

        await Db.Conn.InsertAsync(habit);

        newHabitName = "";
        newHabitOrder += 10m;
        newHabitGood = true;
        newState = HabitImplementationState.Active;

        await Load();
    }

    private async Task DeleteHabit(Habit h)
    {
        await Db.Conn.DeleteAsync(h);
        await Load();
    }
}
